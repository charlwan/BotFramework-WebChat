<!DOCTYPE html>
<html lang="en-US">
  <head>
    <title>Web Chat: Programmatic access to post activity</title>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script src="https://unpkg.com/react@16.5.0/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@16.5.0/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/react-redux@5.0.7/dist/react-redux.min.js"></script>
    <script src="https://unpkg.com/memoize-one@5.0.0/dist/memoize-one.min.js"></script>
    <!--
      For demonstration purposes, we are using the development branch of Web Chat at "/master/webchat.js".
      When you are using Web Chat for production, you should use the latest stable release at "/latest/webchat.js",
      or lock down on a specific version with the following format: "/4.1.0/webchat.js".
    -->
    <!-- <script src="https://cdn.botframework.com/botframework-webchat/master/webchat.js"></script> -->
    <script src="/webchat.js"></script>
    <style>
      html, body { height: 100% }
      body { margin: 0 }

      #root,
      .container,
      .webchat {
        height: 100%;
        width: 100%;
      }

      #endConversation,
      #restartConversation {
        background: White;
        border: solid 1px #CCC;
        cursor: pointer;
        padding: 5px;
        right: 10px;
        position: absolute;
        top: 10px;
      }
    </style>
  </head>
  <body>
    <div id="root" role="main"></div>
    <script type="text/babel">
      (async function () {
        // In this demo, we are using Direct Line token from MockBot.
        // To talk to your bot, you should use the token exchanged using your Direct Line secret.
        // You should never put the Direct Line secret in the browser or client app.
        // https://docs.microsoft.com/en-us/azure/bot-service/rest-api/bot-framework-rest-direct-line-3-0-authentication

        async function fetchDirectLineToken() {
          const res = await fetch('https://webchat-mockbot.azurewebsites.net/directline/token', { method: 'POST' });
          const { token } = await res.json();

          return token;
        }

        const { createStore, ReactWebChat } = window.WebChat;

        class RestartableWebChat extends window.React.Component {
          constructor(props) {
            super(props);

            this.handleEndConversation = this.handleEndConversation.bind(this);
            this.handleRestartConversation = this.handleRestartConversation.bind(this);

            this.state = {
              disabled: false
            };
          }

          async componentDidMount() {
            // We need a new token for every new conversation.
            const token = await fetchDirectLineToken();

            this.setState(() => ({
              directLine: window.WebChat.createDirectLine({ token }),
              store: createStore()
            }));
          }

          handleEndConversation() {
            // We will call disconnect explicitly to stop the conversation.
            // Note that this only stop Direct Line, but not actually sending an endConversation
            this.state.store.dispatch({ type: 'DIRECT_LINE/POST_ACTIVITY', payload: { activity: { type: 'endOfConversation' } } });
            this.state.store.dispatch({ type: 'DIRECT_LINE/DISCONNECT' });

            this.setState(() => ({ disabled: true }));
          }

          async handleRestartConversation() {
            // To create a new conversation, we need to grab a new Direct Line token, because the conversation ID is burnt into the token.
            const token = await fetchDirectLineToken();
            const store = createStore({}, () => {
              console.log('new store');

              return next => action => next(action);
            });

            store.__new = true;

            this.setState(() => ({
              directLine: window.WebChat.createDirectLine({ token }),
              disabled: false,
              store
            }));
          }

          render() {
            const { state: { directLine, disabled, store } } = this;

            return (
              <div className="container">
                {
                  !!directLine &&
                    <ReactWebChat
                      className="webchat"
                      directLine={ directLine }
                      disabled={ disabled }
                      // We are passing our own version of Web Chat store.
                      store={ store }
                    />
                }
                {
                  disabled ?
                    <button
                      id="restartConversation"
                      onClick={ this.handleRestartConversation }
                      type="button"
                    >
                      Restart
                    </button>
                  :
                    <button
                      id="endConversation"
                      onClick={ this.handleEndConversation }
                      type="button"
                    >
                      End
                    </button>
                }
              </div>
            );
          }
        }

        window.ReactDOM.render(
          <RestartableWebChat />,
          document.getElementById('root')
        );
      })().catch(err => console.error(err));
    </script>
  </body>
</html>
